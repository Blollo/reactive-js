<!DOCTYPE html>
<html>
<head>
    <title>Test evalInScope with data-for</title>
</head>
<body>
    <div id="app">
        <h2>Testing evalInScope with data-for loops</h2>

        <h3 [if]="aliceName === 'Alice' && bobName === 'Bob'">Test 0: computed</h3>
        <p>{ aliceName }</p>
        <p>{ aliceName !== 'Alice' ? 'Alice' : 'NO Alice' }</p>
        <p [show]="aliceName !== 'Alice'">Alice name = alice</p>

        <h3>Test 1: Simple data-for with method call</h3>
        <ul>
            <li data-for="item of items">
                <span>{item}</span>
                <button data-onclick="removeItem(item)">Remove</button>
            </li>
        </ul>

        <h3>Test 2: Nested data-for with parent method</h3>
        <div data-for="category of categories">
            <h4>{category.name}</h4>
            <ul>
                <li data-for="product of category.products">
                    {product.name} - ${product.price}
                    <button data-onclick="buyProduct(product)">Buy</button>
                </li>
            </ul>
        </div>

        <h3>Test 3: data-for with computed expressions</h3>
        <div data-for="(user, index) of users">
            <p>
                {index + 1}. {user.name} -
                <span data-text="formatAge(user.age)"></span>
            </p>
        </div>
    </div>

    <script type="module">
        import { ref, computed, scanBindings } from '../reactive.js';

        const items = ref(['Apple', 'Banana', 'Cherry']);

        const categories = ref([
            {
                name: 'Electronics',
                products: [
                    { name: 'Laptop', price: 999 },
                    { name: 'Phone', price: 599 }
                ]
            },
            {
                name: 'Books',
                products: [
                    { name: 'JavaScript Guide', price: 29 },
                    { name: 'CSS Mastery', price: 35 }
                ]
            }
        ]);

        const users = ref([
            { name: 'Alice', age: 25 },
            { name: 'Bob', age: 30 },
            { name: 'Charlie', age: 35 }
        ]);

        const aliceName = computed(() => users.value[0].name);
        const bobName = computed(() => users.value[1].name);

        setTimeout(() => {
            users.value = [
                { name: 'ASD', age: 25 },
                { name: 'QWE', age: 30 },
                { name: '123', age: 35 }
            ];
        }, 2000);

        // Methods that should be accessible in data-for loops
        const store = {
            items,
            categories,
            users,

            aliceName,
            bobName,

            removeItem: (item) => {
                console.log('Removing item:', item);
                const index = items.value.indexOf(item);
                if (index > -1) {
                    items.value.splice(index, 1);
                }
            },

            buyProduct: (product) => {
                console.log('Buying product:', product);
                alert(`Added ${product.name} to cart!`);
            },

            formatAge: (age) => {
                return `${age} years old`;
            }
        };

        // Initialize the app
        scanBindings(document.getElementById('app'), store);

        console.log('App initialized successfully!');
        console.log('Try clicking the buttons - methods should work inside data-for loops');
    </script>
</body>
</html>
