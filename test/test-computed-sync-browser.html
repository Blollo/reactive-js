<!DOCTYPE html>
<html>
<head>
    <title>Test: Synchronous Computed with [if]</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .success { background: lightgreen; padding: 15px; margin: 10px 0; }
        .info { background: lightblue; padding: 15px; margin: 10px 0; }
        .error { background: lightcoral; padding: 15px; margin: 10px 0; }
        .test { border: 2px solid #333; padding: 15px; margin: 20px 0; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; }
        #debug { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>✅ Testing: Synchronous Computed with [if] Directive</h1>

    <div id="debug"></div>

    <div id="app">
        <div class="test">
            <h3>Your Exact Scenario: Computed with [if]</h3>
            <p>AliceName: <strong id="alice-val">?</strong></p>
            <p>BobName: <strong id="bob-val">?</strong></p>
            <p>Condition Result: <strong id="condition-val">?</strong></p>

            <button id="change-btn">Change Users to Charlie & Diana</button>
            <button id="reset-btn">Reset to Alice & Bob</button>

            <h4 [if]="aliceName === 'Alice' && bobName === 'Bob'" class="success">
                ✅ VISIBLE: Alice AND Bob (should disappear when changed)
            </h4>

            <div [if]="aliceName !== 'Alice'" class="info">
                ✅ VISIBLE: Alice name changed to "{aliceName}"
            </div>

            <div [if]="bobName !== 'Bob'" class="info">
                ✅ VISIBLE: Bob name changed to "{bobName}"
            </div>

            <p [show]="aliceName === 'Alice' && bobName === 'Bob'" class="success">
                ✅ SHOWN: Both are Alice and Bob
            </p>
        </div>

        <div class="test">
            <h3>Test: Immediate Access</h3>
            <p id="immediate-test">Click button to test immediate computed access</p>
            <button id="immediate-btn">Test Immediate Access</button>
        </div>

        <div class="test">
            <h3>Test: Multiple Rapid Changes</h3>
            <p>Counter: <span id="counter">0</span></p>
            <button id="rapid-btn">Toggle 10x Rapidly</button>

            <div [if]="showRapid" class="success">
                ✅ Show Rapid is ON
            </div>
        </div>
    </div>

    <script type="module">
        import { ref, computed, scanBindings } from '../reactive.js';

        const debugDiv = document.getElementById('debug');
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            debugDiv.textContent = `[${time}] ${msg}`;
            console.log(msg);
        }

        // Main test
        const users = ref([
            { name: 'Alice', age: 25 },
            { name: 'Bob', age: 30 }
        ]);

        const aliceName = computed(() => users.value[0].name);
        const bobName = computed(() => users.value[1].name);

        // Test rapid toggles
        const showRapid = ref(false);
        let toggleCount = 0;

        const store = {
            users,
            aliceName,
            bobName,
            showRapid
        };

        // Initialize
        scanBindings(document.getElementById('app'), store);

        function updateDisplay() {
            document.getElementById('alice-val').textContent = aliceName.value;
            document.getElementById('bob-val').textContent = bobName.value;
            const condition = aliceName.value === 'Alice' && bobName.value === 'Bob';
            document.getElementById('condition-val').textContent = condition;
        }

        updateDisplay();

        // Change users button
        document.getElementById('change-btn').addEventListener('click', () => {
            log('Changing users to Charlie & Diana');

            users.value = [
                { name: 'Charlie', age: 35 },
                { name: 'Diana', age: 28 }
            ];

            // Computed values should be updated IMMEDIATELY (synchronously)
            log(`Immediately after change: alice="${aliceName.value}", bob="${bobName.value}"`);

            updateDisplay();

            if (aliceName.value === 'Charlie' && bobName.value === 'Diana') {
                log('✅ PASS: Computed values updated synchronously!');
            } else {
                log('❌ FAIL: Computed values not updated immediately!');
            }
        });

        // Reset button
        document.getElementById('reset-btn').addEventListener('click', () => {
            log('Resetting to Alice & Bob');

            users.value = [
                { name: 'Alice', age: 25 },
                { name: 'Bob', age: 30 }
            ];

            updateDisplay();
        });

        // Immediate access test
        document.getElementById('immediate-btn').addEventListener('click', () => {
            log('Testing immediate computed access...');

            const before = { alice: aliceName.value, bob: bobName.value };
            log(`Before: ${JSON.stringify(before)}`);

            users.value = [
                { name: 'Test1', age: 1 },
                { name: 'Test2', age: 2 }
            ];

            const after = { alice: aliceName.value, bob: bobName.value };
            log(`After (immediate): ${JSON.stringify(after)}`);

            if (after.alice === 'Test1' && after.bob === 'Test2') {
                document.getElementById('immediate-test').textContent = '✅ PASS: Values updated immediately!';
                document.getElementById('immediate-test').style.color = 'green';
            } else {
                document.getElementById('immediate-test').textContent = '❌ FAIL: Values not immediate!';
                document.getElementById('immediate-test').style.color = 'red';
            }

            updateDisplay();
        });

        // Rapid toggle test
        document.getElementById('rapid-btn').addEventListener('click', () => {
            log('Toggling 10 times rapidly...');

            for (let i = 0; i < 10; i++) {
                showRapid.value = !showRapid.value;
            }

            toggleCount += 10;
            document.getElementById('counter').textContent = toggleCount;

            log(`Final showRapid value: ${showRapid.value}`);
        });

        log('✅ App initialized - computed values are SYNCHRONOUS!');
    </script>
</body>
</html>
